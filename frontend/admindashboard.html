<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Dashboard - NACOS Complaint System</title>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="./assets/National-Open_University-Nigeria.png" type="image/x-icon">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./styles/admin.css">
    <link rel="stylesheet" href="./styles/navigation.css">
    <link rel="stylesheet" href="./styles/responsive.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <img src="./assets/National-Open_University-Nigeria.png" alt="NACOS Logo" class="sidebar-logo">
                    <div class="logo-text">
                        <h3>NACOS</h3>
                        <span>Complaints System</span>
                    </div>
                </div>
                <button class="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item active">
                        <a href="#admindashboard" class="nav-link" data-section="dashboard">
                            <i class="fas fa-chart-line"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#complaints" class="nav-link" data-section="complaints">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Complaints</span>
                            <span class="nav-badge">23</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#users" class="nav-link" data-section="users">
                            <i class="fas fa-users"></i>
                            <span>Users</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#analytics" class="nav-link" data-section="analytics">
                            <i class="fas fa-chart-bar"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#settings" class="nav-link" data-section="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <div class="admin-profile">
                    <div class="admin-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="admin-info">
                        <div class="admin-name">Admin User</div>
                        <div class="admin-role">Administrator</div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay"></div>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="nav-left">
                    <button class="mobile-menu-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="breadcrumb">
                        <span class="breadcrumb-item">
                            <i class="fas fa-home"></i>
                            Dashboard
                        </span>
                    </div>
                </div>
                
                <div class="nav-right">
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Search...">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                    
                    <div class="nav-actions">
                        <button class="nav-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">3</span>
                        </button>
                        
                        <div class="profile-dropdown">
                            <button class="profile-btn">
                                <div class="profile-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <span class="profile-name">Admin</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            
                            <div class="dropdown-menu">
                                <a href="#profile" class="dropdown-item" data-action="profile">
                                    <i class="fas fa-user-circle"></i>
                                    My Profile
                                </a>
                                <a href="#settings" class="dropdown-item" data-action="settings">
                                    <i class="fas fa-cog"></i>
                                    Settings
                                </a>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item" data-action="logout">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content Wrapper -->
            <div class="content-wrapper" id="content-container">
                <!-- Dashboard content will be loaded here dynamically -->
                <div class="section-header">
                    <h1 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Dashboard Overview
                    </h1>
                    <p class="section-subtitle">Welcome back! Here's what's happening with your complaints system.</p>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="pending-count">23</div>
                            <div class="stat-label">Pending Complaints</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+12% from last week</span>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card info">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="inprogress-count">12</div>
                            <div class="stat-label">In Progress</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+8% from last week</span>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card success">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="resolved-count">121</div>
                            <div class="stat-label">Resolved</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+24% from last week</span>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card warning">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="total-users">89</div>
                            <div class="stat-label">Total Users</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+5% from last week</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3 class="subsection-title">
                        <i class="fas fa-bolt"></i>
                        Quick Actions
                    </h3>
                    <div class="action-grid">
                        <button class="action-btn primary" data-action="view-complaints">
                            <i class="fas fa-list"></i>
                            <span>View All Complaints</span>
                        </button>
                        <button class="action-btn secondary" data-action="add-user">
                            <i class="fas fa-user-plus"></i>
                            <span>Add New User</span>
                        </button>
                        <button class="action-btn tertiary" data-action="generate-report">
                            <i class="fas fa-chart-bar"></i>
                            <span>Generate Report</span>
                        </button>
                        <button class="action-btn quaternary" data-action="system-settings">
                            <i class="fas fa-cog"></i>
                            <span>System Settings</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <div class="section-header">
                        <h3 class="subsection-title">
                            <i class="fas fa-history"></i>
                            Recent Complaints
                        </h3>
                        <button class="table-btn" data-action="view-all-complaints">
                            <i class="fas fa-eye"></i>
                            View All
                        </button>
                    </div>
                    <div class="table-container table-responsive">
                        <table class="modern-table" id="dashboard-complaints-table">
                            <thead>
                                <tr>
                                    <th>Ticket ID</th>
                                    <th>Student</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-complaints-tbody">
                                <tr>
                                    <td data-label="Ticket ID"><strong>NACOS-000001</strong></td>
                                    <td data-label="Student">
                                        <div class="user-info">
                                            <div class="user-name">John Doe</div>
                                            <div class="user-email">CS/2020/001</div>
                                        </div>
                                    </td>
                                    <td data-label="Type"><span class="type-badge">Academic</span></td>
                                    <td data-label="Status"><span class="status-badge pending">Pending</span></td>
                                    <td data-label="Priority"><span class="priority-badge medium">Medium</span></td>
                                    <td data-label="Date">Jan 15, 2024</td>
                                    <td data-label="Actions">
                                        <div class="table-actions">
                                            <button class="action-icon view" title="View Details" data-action="view-complaint" data-id="1">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="action-icon edit" title="Edit Status" data-action="edit-complaint" data-id="1">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="action-icon delete" title="Delete" data-action="delete-complaint" data-id="1">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td data-label="Ticket ID"><strong>NACOS-000002</strong></td>
                                    <td data-label="Student">
                                        <div class="user-info">
                                            <div class="user-name">Jane Smith</div>
                                            <div class="user-email">CS/2020/002</div>
                                        </div>
                                    </td>
                                    <td data-label="Type"><span class="type-badge">Technical</span></td>
                                    <td data-label="Status"><span class="status-badge in_progress">In Progress</span></td>
                                    <td data-label="Priority"><span class="priority-badge high">High</span></td>
                                    <td data-label="Date">Jan 14, 2024</td>
                                    <td data-label="Actions">
                                        <div class="table-actions">
                                            <button class="action-icon view" title="View Details" data-action="view-complaint" data-id="2">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="action-icon edit" title="Edit Status" data-action="edit-complaint" data-id="2">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="action-icon delete" title="Delete" data-action="delete-complaint" data-id="2">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td data-label="Ticket ID"><strong>NACOS-000003</strong></td>
                                    <td data-label="Student">
                                        <div class="user-info">
                                            <div class="user-name">Mike Johnson</div>
                                            <div class="user-email">CS/2020/003</div>
                                        </div>
                                    </td>
                                    <td data-label="Type"><span class="type-badge">Administrative</span></td>
                                    <td data-label="Status"><span class="status-badge resolved">Resolved</span></td>
                                    <td data-label="Priority"><span class="priority-badge low">Low</span></td>
                                    <td data-label="Date">Jan 13, 2024</td>
                                    <td data-label="Actions">
                                        <div class="table-actions">
                                            <button class="action-icon view" title="View Details" data-action="view-complaint" data-id="3">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="action-icon edit" title="Edit Status" data-action="edit-complaint" data-id="3">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="action-icon delete" title="Delete" data-action="delete-complaint" data-id="3">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Core JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Authentication Helper (Add this before other scripts) -->
    <script>
        // Simple authentication setup for development/testing
        (function () {
            const role = localStorage.getItem('role');
            const username = localStorage.getItem('username');
            const token = localStorage.getItem('authToken');

            console.log("Auth check before initialization:", { role, username, token });

            // Set test credentials if none exist (development only)
            if (!token || !username || !role) {
                console.log("Setting development admin credentials");
                localStorage.setItem('role', 'admin');
                localStorage.setItem('username', 'Admin User');
                localStorage.setItem('authToken', 'dev-token-12345');
            }
        })();
    </script>

    <!-- Application Scripts -->
    <script src="script/api.js"></script>
    <script src="script/navigation.js"></script>
    <script src="script/settings.js"></script>
    <script src="script/analytics.js"></script>
    <script src="script/admindashboard.js"></script>

    <!-- Sidebar Navigation Fix -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Setting up sidebar navigation handlers...');

            // Get all navigation links in the sidebar
            const navLinks = document.querySelectorAll('.sidebar .nav-link');

            // Add click handler to each link
            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();

                    // Get the section to navigate to
                    const section = this.getAttribute('data-section');
                    console.log('Sidebar link clicked:', section);

                    // Update active state in sidebar
                    document.querySelectorAll('.sidebar .nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    this.closest('.nav-item').classList.add('active');

                    // Update breadcrumb
                    const breadcrumb = document.querySelector('.breadcrumb-item');
                    if (breadcrumb) {
                        let icon = 'fas fa-home';
                        if (section === 'complaints') icon = 'fas fa-exclamation-triangle';
                        else if (section === 'users') icon = 'fas fa-users';
                        else if (section === 'analytics') icon = 'fas fa-chart-bar';
                        else if (section === 'settings') icon = 'fas fa-cog';

                        breadcrumb.innerHTML = `<i class="${icon}"></i> ${section.charAt(0).toUpperCase() + section.slice(1)}`;
                    }

                    // Load appropriate view based on section
                    loadSectionView(section);
                });
            });

            // Function to load view from file
            async function loadSectionView(section) {
                try {
                    // Show loading indicator in content area
                    const contentContainer = document.getElementById('content-container');
                    contentContainer.innerHTML = `
                        <div class="loading-indicator">
                            <i class="fas fa-circle-notch fa-spin"></i>
                            <span>Loading ${section}...</span>
                        </div>
                    `;

                    if (section === 'dashboard') {
                    // For dashboard, just refresh the current view
                        showDashboardContent();
                        if (window.adminDashboard) {
                            window.adminDashboard.refreshDashboard();
                        }
            
                        // Close sidebar on mobile
                        if (window.innerWidth <= 768) {
                            toggleSidebar();
                        }
                        return;
                    }

                    let html = null;
                    let fetchError = null;

                    // Try multiple possible paths for the view files
                    const possiblePaths = [
                        `./views/${section}.html`,
                        `../views/${section}.html`,
                        `./frontend/views/${section}.html`,
                        `./${section}.html`
                    ];

                    for (const path of possiblePaths) {
                        try {
                            console.log(`Trying to load view from: ${path}`);
                            const response = await fetch(path);
                            if (response.ok) {
                                html = await response.text();
                                console.log(`Successfully loaded view from: ${path}`);
                                break;
                            } else {
                                console.log(`Path ${path} returned ${response.status}`);
                            }
                        } catch (e) {
                            console.log(`Error loading from ${path}: ${e.message}`);
                            fetchError = e;
                        }
                    }

                    // If we couldn't load the file from any path, use fallback template
                    if (!html) {
                        console.log(`No view file found for ${section}, using fallback template`);
                        html = getFallbackTemplate(section);
                    }

                    // First, hide dashboard content
                    document.querySelectorAll('.content-wrapper > *:not(.content-section)').forEach(el => {
                        el.style.display = 'none';
                    });

                    // Remove any existing section with the same ID
                    const existingSection = document.getElementById(`${section}-section`);
                    if (existingSection) {
                        existingSection.remove();
                    }

                    // Create new section element
                    const sectionElement = document.createElement('div');
                    sectionElement.id = `${section}-section`;
                    sectionElement.className = 'content-section';
        
                    // Add mobile-specific class if needed
                    if (window.innerWidth <= 768) {
                        sectionElement.classList.add('mobile-view');
                    }
        
                    sectionElement.innerHTML = html;
                    sectionElement.style.display = 'block';

                    // Add to DOM
                    contentContainer.innerHTML = '';
                    contentContainer.appendChild(sectionElement);

                    // Initialize section if needed
                    if (section === 'analytics' && window.analyticsController) {
                        window.analyticsController.initialize();
                    } else if (section === 'settings' && window.settingsController) {
                        window.settingsController.loadSettings();
                    } else if (section === 'complaints' && window.adminDashboard) {
                        window.adminDashboard.loadAllComplaints();
                    } else if (section === 'users' && window.adminDashboard) {
                        window.adminDashboard.loadAllUsers();
                    }
        
                    // Convert tables to responsive mobile cards on small screens
                    if (window.innerWidth <= 480) {
                        const tables = sectionElement.querySelectorAll('.table-container');
                        tables.forEach(table => {
                            table.classList.add('mobile-cards');
                        });
                    }

                    // Close sidebar on mobile
                    if (window.innerWidth <= 768) {
                        toggleSidebar();
                    }

                    console.log(`Successfully loaded ${section} view`);
                } catch (error) {
                    console.error(`Error loading ${section} view:`, error);

                    // Show error message
                    const contentContainer = document.getElementById('content-container');
                    contentContainer.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Failed to load ${section} view: ${error.message}</span>
                            <div class="error-actions">
                                <button class="btn-primary" onclick="loadSectionView('${section}')">
                                    <i class="fas fa-sync-alt"></i> Try Again
                                </button>
                                <button class="btn-secondary" onclick="window.location.reload()">
                                    <i class="fas fa-redo"></i> Reload Page
                                </button>
                            </div>
                        </div>
                    `;
        
                    // Close sidebar on mobile
                    if (window.innerWidth <= 768) {
                        toggleSidebar();
                    }
                }
            }

            // Add this fallback template function right after loadSectionView
            function getFallbackTemplate(section) {
                if (section === 'complaints') {
                    return `
                        <div class="section-header">
                            <h1 class="section-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Complaints Management
                            </h1>
                            <p class="section-subtitle">View and manage all student complaints in the system.</p>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3>All Complaints</h3>
                                <div class="card-actions">
                                    <button class="btn-primary">
                                        <i class="fas fa-filter"></i> Filter
                                    </button>
                                    <button class="btn-secondary">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="loading-indicator">
                                    <i class="fas fa-circle-notch fa-spin"></i>
                                    <span>Loading complaints data...</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (section === 'users') {
                    return `
                        <div class="section-header">
                            <h1 class="section-title">
                                <i class="fas fa-users"></i>
                                Users Management
                            </h1>
                            <p class="section-subtitle">Manage system users and their permissions.</p>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3>All Users</h3>
                                <div class="card-actions">
                                    <button class="btn-primary">
                                        <i class="fas fa-plus"></i> Add User
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="loading-indicator">
                                    <i class="fas fa-circle-notch fa-spin"></i>
                                    <span>Loading users data...</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (section === 'analytics') {
                    return `
                        <div class="section-header">
                            <h1 class="section-title">
                                <i class="fas fa-chart-bar"></i>
                                Analytics & Reports
                            </h1>
                            <p class="section-subtitle">View system metrics and generate reports.</p>
                        </div>
                        
                        <div id="analytics-container">
                            <div class="loading-indicator">
                                <i class="fas fa-circle-notch fa-spin"></i>
                                <span>Loading analytics data...</span>
                            </div>
                        </div>
                    `;
                } else if (section === 'settings') {
                    return `
                        <div class="section-header">
                            <h1 class="section-title">
                                <i class="fas fa-cog"></i>
                                System Settings
                            </h1>
                            <p class="section-subtitle">Configure system preferences and options.</p>
                        </div>
                        
                        <div class="settings-container">
                            <div class="loading-indicator">
                                <i class="fas fa-circle-notch fa-spin"></i>
                                <span>Loading settings data...</span>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="section-header">
                            <h1 class="section-title">
                                <i class="fas fa-file-alt"></i>
                                ${section.charAt(0).toUpperCase() + section.slice(1)}
                            </h1>
                            <p class="section-subtitle">This section is currently under construction.</p>
                        </div>
                        
                        <div class="card">
                            <div class="card-body" style="text-align: center; padding: 3rem;">
                                <i class="fas fa-tools" style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;"></i>
                                <h2>Coming Soon</h2>
                                <p>This feature is currently being developed.</p>
                            </div>
                        </div>
                    `;
                }
            }

            // Function to show dashboard content
            function showDashboardContent() {
                // Show main dashboard content
                document.querySelectorAll('.content-wrapper > *:not(.content-section)').forEach(el => {
                    el.style.display = '';
                });

                // Hide any section content
                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                });
            }

            // Also handle logout action
            const logoutButton = document.querySelector('[data-action="logout"]');
            if (logoutButton) {
                logoutButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (window.api && typeof window.api.logout === 'function') {
                        window.api.logout(true);
                    } else {
                        // Fallback logout
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('username');
                        localStorage.removeItem('role');
                        window.location.href = 'index.html';
                    }
                });
            }
            
            // Mobile menu functionality
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const sidebar = document.querySelector('.sidebar');
            const sidebarOverlay = document.querySelector('.sidebar-overlay');
            
            // Function to toggle sidebar
            function toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                const sidebarOverlay = document.querySelector('.sidebar-overlay');

                sidebar.classList.toggle('active');
                
                // Toggle overlay
                if (sidebarOverlay) {
                    sidebarOverlay.classList.toggle('active');
                }
                
                // Toggle body scroll
                if (sidebar.classList.contains('active')) {
                    document.body.style.overflow = 'hidden'; // Prevent scrolling
                } else {
                    document.body.style.overflow = ''; // Enable scrolling
                }
            }
            
            // Make toggleSidebar available globally
            window.toggleSidebar = toggleSidebar;
            
            // Mobile menu button click
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleSidebar();
                });
            }
            
            // Close sidebar when clicking overlay
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    toggleSidebar();
                });
            }
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768 && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    if (sidebarOverlay) {
                        sidebarOverlay.classList.remove('active');
                    }
                    document.body.style.overflow = '';
                }
                
                // Update table display
                document.querySelectorAll('.content-section').forEach(section => {
                    if (section.style.display === 'block') {
                        const tables = section.querySelectorAll('.table-container');
                        tables.forEach(table => {
                            if (window.innerWidth <= 480) {
                                table.classList.add('mobile-cards');
                            } else {
                                table.classList.remove('mobile-cards');
                            }
                        });
                    }
                });
                
                // Add/remove mobile-view class
                document.querySelectorAll('.content-section').forEach(section => {
                    if (window.innerWidth <= 768) {
                        section.classList.add('mobile-view');
                    } else {
                        section.classList.remove('mobile-view');
                    }
                });
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Update username from localStorage after all other scripts have loaded
            setTimeout(() => {
                const username = localStorage.getItem('username');

                if (username) {
                    // Update all username elements
                    document.querySelectorAll('.admin-name').forEach(el => {
                        el.textContent = username;
                    });

                    document.querySelectorAll('.profile-name').forEach(el => {
                        el.textContent = username;
                    });

                    console.log('Username updated to:', username);
                }
            }, 500);
        });
    </script>

    <!-- Analytics Controller -->
<script>
  // Analytics Controller
  class AnalyticsController {
    constructor() {
      this.charts = {};
      console.log('Analytics Controller initialized');
    }

    // Initialize analytics dashboard
    initialize() {
      console.log('Initializing analytics dashboard...');
      
      // Set up analytics layout
      this.setupLayout();
      
      // Load analytics data
      this.loadAnalyticsData();
    }

    // Set up the analytics layout
    setupLayout() {
      const container = document.getElementById('analytics-container');
      if (!container) return;
      
      container.innerHTML = `
        <div class="analytics-grid">
          <div class="card">
            <div class="card-header">
              <h3>Complaint Volume Over Time</h3>
            </div>
            <div class="card-body">
              <canvas id="complaints-timeline-chart"></canvas>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3>Complaints by Category</h3>
            </div>
            <div class="card-body">
              <canvas id="complaints-category-chart"></canvas>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3>Resolution Rate</h3>
            </div>
            <div class="card-body">
              <canvas id="resolution-rate-chart"></canvas>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3>Average Response Time</h3>
            </div>
            <div class="card-body">
              <div class="stat-highlight">
                <span class="stat-value">32</span>
                <span class="stat-unit">hours</span>
              </div>
              <p class="stat-description">Average time to first response</p>
            </div>
          </div>
        </div>
        
        <div class="card mt-4">
          <div class="card-header">
            <h3>Generate Custom Reports</h3>
          </div>
          <div class="card-body">
            <form id="report-form" class="report-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="report-type">Report Type</label>
                  <select id="report-type" class="form-control">
                    <option value="complaints">Complaints Summary</option>
                    <option value="users">User Activity</option>
                    <option value="response-time">Response Time Analysis</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="report-period">Time Period</label>
                  <select id="report-period" class="form-control">
                    <option value="7days">Last 7 Days</option>
                    <option value="30days">Last 30 Days</option>
                    <option value="90days">Last 90 Days</option>
                    <option value="custom">Custom Range</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="report-format">Format</label>
                  <select id="report-format" class="form-control">
                    <option value="pdf">PDF</option>
                    <option value="excel">Excel</option>
                    <option value="csv">CSV</option>
                  </select>
                </div>
              </div>
              
              <div id="custom-date-range" class="form-row" style="display:none;">
                <div class="form-group">
                  <label for="start-date">Start Date</label>
                  <input type="date" id="start-date" class="form-control">
                </div>
                
                <div class="form-group">
                  <label for="end-date">End Date</label>
                  <input type="date" id="end-date" class="form-control">
                </div>
              </div>
              
              <button type="submit" class="btn-primary">
                <i class="fas fa-file-export"></i> Generate Report
              </button>
            </form>
          </div>
        </div>
      `;
      
      // Setup custom date range toggle
      const periodSelect = document.getElementById('report-period');
      const customDateRange = document.getElementById('custom-date-range');
      
      if (periodSelect && customDateRange) {
        periodSelect.addEventListener('change', () => {
          if (periodSelect.value === 'custom') {
            customDateRange.style.display = 'flex';
          } else {
            customDateRange.style.display = 'none';
          }
        });
      }
      
      // Setup report form submission
      const reportForm = document.getElementById('report-form');
      if (reportForm) {
        reportForm.addEventListener('submit', (e) => {
          e.preventDefault();
          this.generateReport();
        });
      }
    }

    // Load analytics data from API
    async loadAnalyticsData() {
      try {
        // Show loading indicators for charts
        this.showChartLoading('complaints-timeline-chart');
        this.showChartLoading('complaints-category-chart');
        this.showChartLoading('resolution-rate-chart');
        
        // Try to fetch analytics data from API
        let analyticsData;
        try {
          if (window.api && typeof window.api.getAnalyticsData === 'function') {
            const response = await window.api.getAnalyticsData();
            if (response.success) {
              analyticsData = response.data;
            } else {
              throw new Error('Failed to load analytics data');
            }
          } else {
            throw new Error('API not available');
          }
        } catch (error) {
          console.warn('Using fallback analytics data:', error);
          analyticsData = this.getFallbackData();
        }
        
        // Create charts with the data
        this.createTimelineChart(analyticsData.monthlyStats);
        this.createCategoryChart(analyticsData.complaintTypes);
        this.createResolutionChart();
        
      } catch (error) {
        console.error('Error loading analytics data:', error);
        Swal.fire({
          icon: 'error',
          title: 'Analytics Error',
          text: 'Failed to load analytics data. Please try again later.'
        });
      }
    }

    // Create timeline chart
    createTimelineChart(monthlyData) {
      const ctx = document.getElementById('complaints-timeline-chart');
      if (!ctx) return;
      
      // Extract data from API response
      const labels = monthlyData.map(item => item.month);
      const pendingData = monthlyData.map(item => item.pending);
      const inProgressData = monthlyData.map(item => item.inProgress);
      const resolvedData = monthlyData.map(item => item.resolved);
      
      // Create chart
      this.charts.timeline = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Pending',
              data: pendingData,
              borderColor: '#ff9800',
              backgroundColor: 'rgba(255, 152, 0, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'In Progress',
              data: inProgressData,
              borderColor: '#2196f3',
              backgroundColor: 'rgba(33, 150, 243, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Resolved',
              data: resolvedData,
              borderColor: '#4caf50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false,
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Complaints'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Month'
              }
            }
          }
        }
      });
    }

    // Create category chart
    createCategoryChart(categoryData) {
      const ctx = document.getElementById('complaints-category-chart');
      if (!ctx) return;
      
      // Extract data
      const labels = Object.keys(categoryData);
      const data = Object.values(categoryData);
      
      // Create chart
      this.charts.category = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              '#4CAF50', // Academic
              '#2196F3', // Technical
              '#FFC107', // Administrative
              '#9C27B0', // Facility
              '#FF5722'  // Other
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
            }
          }
        }
      });
    }

    // Create resolution rate chart
    createResolutionChart() {
      const ctx = document.getElementById('resolution-rate-chart');
      if (!ctx) return;
      
      this.charts.resolution = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['< 24h', '24-48h', '48-72h', '> 72h'],
          datasets: [{
            label: 'Resolution Time',
            data: [42, 23, 15, 8],
            backgroundColor: [
              'rgba(76, 175, 80, 0.7)',   // Green for fast
              'rgba(255, 193, 7, 0.7)',   // Yellow for medium
              'rgba(255, 152, 0, 0.7)',   // Orange for slow
              'rgba(244, 67, 54, 0.7)'    // Red for very slow
            ],
            borderColor: [
              'rgba(76, 175, 80, 1)',
              'rgba(255, 193, 7, 1)',
              'rgba(255, 152, 0, 1)',
              'rgba(244, 67, 54, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Complaints'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Resolution Time'
              }
            }
          }
        }
      });
    }

    // Show loading indicator while chart data loads
    showChartLoading(chartId) {
      const chartCanvas = document.getElementById(chartId);
      if (!chartCanvas) return;
      
      const container = chartCanvas.parentNode;
      if (container) {
        const loadingEl = document.createElement('div');
        loadingEl.className = 'chart-loading';
        loadingEl.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
        
        // Position the loading indicator over the chart area
        loadingEl.style.position = 'absolute';
        loadingEl.style.top = '0';
        loadingEl.style.left = '0';
        loadingEl.style.width = '100%';
        loadingEl.style.height = '100%';
        loadingEl.style.display = 'flex';
        loadingEl.style.alignItems = 'center';
        loadingEl.style.justifyContent = 'center';
        loadingEl.style.backgroundColor = 'rgba(255,255,255,0.8)';
        loadingEl.style.color = '#6c757d';
        loadingEl.style.fontSize = '2rem';
        loadingEl.style.zIndex = '1';
        
        // Set container to relative if it's not already
        if (window.getComputedStyle(container).position === 'static') {
          container.style.position = 'relative';
        }
        
        container.appendChild(loadingEl);
        
        // Remove loading after timeout to prevent hanging
        setTimeout(() => {
          const loadingElement = container.querySelector('.chart-loading');
          if (loadingElement) {
            loadingElement.remove();
          }
        }, 5000);
      }
    }

    // Generate report
    generateReport() {
      const reportType = document.getElementById('report-type').value;
      const reportPeriod = document.getElementById('report-period').value;
      const reportFormat = document.getElementById('report-format').value;
      
      let startDate, endDate;
      if (reportPeriod === 'custom') {
        startDate = document.getElementById('start-date').value;
        endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
          Swal.fire({
            icon: 'warning',
            title: 'Missing Dates',
            text: 'Please select both start and end dates for custom range'
          });
          return;
        }
      }
      
      const reportConfig = {
        type: reportType,
        period: reportPeriod,
        format: reportFormat,
        startDate,
        endDate
      };
      
      Swal.fire({
        title: 'Generating Report',
        text: 'Please wait while we generate your report...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
          
          // Call API to generate report
          if (window.api && typeof window.api.generateReport === 'function') {
            window.api.generateReport(reportConfig)
              .then(response => {
                Swal.close();
                
                if (response.success) {
                  Swal.fire({
                    icon: 'success',
                    title: 'Report Generated',
                    text: `Your ${reportType} report has been generated successfully!`,
                    confirmButtonText: 'Download',
                    showCancelButton: true,
                    cancelButtonText: 'Close'
                  }).then(result => {
                    if (result.isConfirmed && response.downloadUrl) {
                      window.open(response.downloadUrl, '_blank');
                    }
                  });
                } else {
                  Swal.fire({
                    icon: 'error',
                    title: 'Report Generation Failed',
                    text: response.message || 'Could not generate report'
                  });
                }
              })
              .catch(error => {
                console.error('Error generating report:', error);
                Swal.fire({
                  icon: 'error',
                  title: 'Report Generation Failed',
                  text: 'An error occurred while generating the report'
                });
              });
          } else {
            // Fallback for development
            setTimeout(() => {
              Swal.close();
              Swal.fire({
                icon: 'success',
                title: 'Report Generated (Development Mode)',
                text: `Your ${reportType} report would be generated here in production`,
                confirmButtonText: 'OK'
              });
            }, 1500);
          }
        }
      });
    }

    // Fallback data when API is unavailable
    getFallbackData() {
      // Generate some reasonable sample data
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const now = new Date();
      const monthData = [];
      
      // Generate 12 months of data
      for (let i = 0; i < 12; i++) {
        const month = new Date(now.getFullYear(), now.getMonth() - 11 + i, 1);
        const monthName = monthNames[month.getMonth()];
        
        // Generate some random but somewhat realistic numbers
        // Make them increase slightly over time for a realistic trend
        const basePending = 5 + Math.floor(i / 2);
        const baseInProgress = 3 + Math.floor(i / 3);
        const baseResolved = 8 + Math.floor(i * 1.5);
        
        monthData.push({
          month: monthName,
          pending: basePending + Math.floor(Math.random() * 5),
          inProgress: baseInProgress + Math.floor(Math.random() * 4),
          resolved: baseResolved + Math.floor(Math.random() * 8)
        });
      }
      
      return {
        monthlyStats: monthData,
        complaintTypes: {
          'Academic': 15,
          'Technical': 8,
          'Administrative': 12,
          'Facility': 5,
          'Other': 3
        },
        responseTime: {
          average: 32, // hours
          min: 2,
          max: 96
        }
      };
    }
  }
  
  // Initialize the controller and make it available globally
  window.analyticsController = new AnalyticsController();
  console.log('Analytics Controller registered globally');
</script>
</body>
</html>